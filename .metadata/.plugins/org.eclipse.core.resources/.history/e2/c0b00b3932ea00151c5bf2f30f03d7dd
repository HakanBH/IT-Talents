package mobile.jdbc;

import java.sql.*;
import mobile.model.*;

public class UserDAO implements IUserDAO {

	@Override
	public boolean hasEmail(String email) throws SQLException {
		try (Connection connection = DBConnection.getInstance().getConnection();
				PreparedStatement checkEmail = connection
						.prepareStatement("select email from users where email like ?")) {
			boolean hasEmail = false;

			checkEmail.setString(1, email);
			ResultSet res = checkEmail.executeQuery();
			if (res.next()) {
				hasEmail = true;
				System.out.println("Този Е-мейл е вече зает. Моля пробвайте отново.");
			}

		} catch (SQLException e) {
			e.printStackTrace();
		}
		return hasEmail;
	}

	@Override
	public User getUserByID(int userID) throws Exception {
		try (Connection connection = DBConnection.getInstance().getConnection();
				PreparedStatement searchByID = connection.prepareStatement("select * from users where user_id = ?")) {
			searchByID.setInt(1, userID);
			ResultSet result = searchByID.executeQuery();
			result.next();

			return new User(result.getString(2), result.getString(3), result.getString(4), result.getString(5),
					result.getString(6));
		} catch (SQLException e) {
			e.printStackTrace();
			throw new Exception("User with that id cannot be found.", e);
		}
	}

	@Override
	public void register(User u) throws Exception {
		if (u != null) {
			Connection connection = DBConnection.getInstance().getConnection();
			try {
				PreparedStatement register = connection.prepareStatement("insert into users values(null, ?,?,?,?,?);",
						PreparedStatement.RETURN_GENERATED_KEYS);
				register.setString(1, u.getEmail());
				register.setString(2, u.getPassword());
				register.setString(3, u.getFirstName());
				register.setString(4, u.getLastName());
				register.setString(5, u.getRegion());
				register.executeUpdate();

				ResultSet res = register.getGeneratedKeys();
				res.next();

			} catch (SQLException e) {
				e.printStackTrace();
				throw new Exception("Error. Please try again", e);
			}
		} else {
			throw new Exception("Sorry! An error accured. Please try again.");
		}
	}

	@Override
	public int login(String email, String password) throws Exception {
		Connection connection = DBConnection.getInstance().getConnection();
		if (email == null || password == null) {
			throw new Exception("Sorry. An error accured. Please try again.");
		}

		try {
			PreparedStatement login = connection
					.prepareStatement("select * from users where email like ? and password like ?");
			login.setString(1, email);
			login.setString(2, password);

			ResultSet res = login.executeQuery();
			res.next();
			int userId = res.getInt(1);

			return userId;
		} catch (SQLException e) {
			e.printStackTrace();
			throw new Exception("Invalid email or password!", e);
		}
	}
}
